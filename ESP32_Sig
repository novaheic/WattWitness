#include <Wire.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <Arduino.h>
#include <ArduinoECCX08.h>

// WiFi credentials
const char* ssid = "Ondemand";           // <-- CHANGE THIS
const char* password = "CasaBerlin";   // <-- CHANGE THIS
const char* shellyHost = "192.168.178.156"; // <-- CHANGE THIS

void fetchAndSignTelemetry() {
  HTTPClient http;
  String url = String("http://") + shellyHost + "/status";
  http.begin(url);
  int httpCode = http.GET();
  if (httpCode != 200) {
    Serial.println("âŒ Failed to fetch ShellyEM data.");
    http.end();
    return;
  }

  String payload = http.getString();
  http.end();

  Serial.println("ðŸ“¦ Shelly payload:");
  Serial.println(payload);

  float power = 0.0;
  float total_kwh = 0.0;
  long timestamp = 0;

  int pIndex = payload.indexOf("\"power\":");
  if (pIndex != -1) {
    power = payload.substring(pIndex + 8).toFloat();
  }

  int tIndex = payload.indexOf("\"total\":");
  if (tIndex != -1) {
    total_kwh = payload.substring(tIndex + 8).toFloat();
  }

  float total_wh = total_kwh * 1000.0;

  int tsIndex = payload.indexOf("\"unixtime\":");
  if (tsIndex != -1) {
    timestamp = payload.substring(tsIndex + 11).toInt();
  }

  char message[64];
  snprintf(message, sizeof(message), "ShellyEM power=%.1fW total=%.1fWh timestamp=%ld", power, total_wh, timestamp);
  Serial.print("ðŸ“Š Data: ");
  Serial.println(message);

  // Sign message
  char padded[64] = {0};
  strncpy(padded, message, sizeof(padded));

  uint8_t signature[64];

  if (ECCX08.beginSHA256()) {
    ECCX08.updateSHA256((const byte*)padded);
    if (ECCX08.endSHA256(signature)) {
      Serial.print("âœï¸ Signature: ");
      for (int i = 0; i < 64; i++) {
        if (signature[i] < 0x10) Serial.print("0");
        Serial.print(signature[i], HEX);
      }
      Serial.println();
    } else {
      Serial.println("âŒ SHA256 + Sign failed");
    }
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("ðŸ” WattWitness: Live Signing Mode");

  WiFi.begin(ssid, password);
  Serial.print("ðŸ“¶ Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\nâœ… WiFi connected");

  Wire.begin(21, 22);
  Wire.setClock(400000);

  if (!ECCX08.begin()) {
    Serial.println("âŒ ATECC608A not found.");
    while (1);
  }
  Serial.println("âœ… ATECC608A initialized.");
}

void loop() {
  fetchAndSignTelemetry();
  delay(10000); // wait 10 seconds before repeating
}
